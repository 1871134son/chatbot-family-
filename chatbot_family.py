import streamlit as st
import google.generativeai as genai

# ==========================================
# 1. í™”ë©´ ì„¤ì • ë° ë””ìì¸
# ==========================================
st.set_page_config(
    page_title="ì†ê¸°í˜&ê¹€ì˜ìˆ™ ê°€ì¡± ì±—ë´‡ë°©! ğŸ ",
    page_icon="ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦",
    layout="centered"
)

# [CSS í•´í‚¹] ì§€ì €ë¶„í•œ ë©”ë‰´ ìˆ¨ê¸°ê¸° & ì˜ˆìœ í°íŠ¸ ì ìš©
hide_bar = """
<style>
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}
    .stChatMessage {font-family: 'Pretendard', sans-serif;}
</style>
"""
st.markdown(hide_bar, unsafe_allow_html=True)

st.title("ğŸ  í–‰ë³µí•œ ìš°ë¦¬ ê°€ì¡± ì±„íŒ…ë°©")
st.caption("ğŸš€ ì–¸ì œë“  ë‚´ í¸ì´ ë˜ì–´ì£¼ëŠ” AI ê°€ì¡± ìƒë‹´ì†Œ")

# ==========================================
# 2. API í‚¤ ì„¤ì • (ë¹„ë°€ë²ˆí˜¸ ê¸ˆê³ )
# ==========================================
# GitHub ë°°í¬ ì‹œì—” st.secretsë¥¼ ì‚¬ìš©í•˜ê³ , 
# ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œì—” ì•„ë˜ì— ì§ì ‘ í‚¤ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ secrets.tomlì„ ì„¸íŒ…í•´ì•¼ í•¨
if "MY_API_KEY" in st.secrets:
    MY_API_KEY = st.secrets["MY_API_KEY"]

genai.configure(api_key=MY_API_KEY)

# ==========================================
# 3. ì‚¬ìš©ì ì„ íƒ (ì‚¬ì´ë“œë°”) & í˜ë¥´ì†Œë‚˜ ì„¤ì •
# ==========================================
with st.sidebar:
    st.header("ğŸ‘¤ ëˆ„êµ¬ì„¸ìš”?")
    selected_user = st.radio(
        "ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”(ì´ë¦„ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.):",
        ("ì•„ë²„ì§€ (ì†ê¸°í˜)", "ì–´ë¨¸ë‹ˆ (ê¹€ì˜ìˆ™)", "ë§‰ë‚´ (ì†ì¤€í˜¸)")
    )
    st.info("ğŸ’¡ ì´ë¦„ì„ ëˆ„ë¥´ë©´ ë§ì¶¤í˜• ëŒ€í™” ìƒëŒ€ë¡œ ë³€ì‹ í•©ë‹ˆë‹¤!")

# [í•µì‹¬ ë¡œì§] ì‚¬ìš©ìê°€ ë°”ë€Œë©´ ëŒ€í™” ë‚´ìš©ì„ ì´ˆê¸°í™”í•´ì•¼ í•¨
if "current_user" not in st.session_state:
    st.session_state.current_user = selected_user

if st.session_state.current_user != selected_user:
    st.session_state.messages = [] # ëŒ€í™” ë‚´ìš© ì§€ìš°ê¸°
    st.session_state.chat_session = None # ì„¸ì…˜ ì´ˆê¸°í™”
    st.session_state.current_user = selected_user # í˜„ì¬ ì‚¬ìš©ì ì—…ë°ì´íŠ¸
    st.rerun() # í™”ë©´ ìƒˆë¡œê³ ì¹¨

# ==========================================
# 4. ê°€ì¡±ë³„ AI ì„±ê²©(System Instruction) ì •ì˜
# ==========================================
def get_system_instruction(user):
    base_instruction = "ë„ˆëŠ” ì´ ê°€ì¡±ì„ ë„ˆë¬´ë‚˜ ì‚¬ë‘í•˜ê³  ì•„ë¼ëŠ” AI ë¹„ì„œì•¼. ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ë”°ëœ»í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ í•´ì¤˜."
    
    if user == "ì•„ë²„ì§€ (ì†ê¸°í˜)":
        return base_instruction + """
        [User Info] ì´ë¦„: ì†ê¸°í˜ (71ë…„ìƒ), ì§ì—…: êµ­ë°©ê³¼í•™ì—°êµ¬ì†Œ ê²½ë¹„ì›.
        [Situation] ìµœê·¼ ì•” ì¹˜ë£Œ ì¤‘ì´ë¼ ëª¸ê³¼ ë§ˆìŒì´ ì§€ì¹  ìˆ˜ ìˆìŒ. ì‹œ ì“°ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ì‹¬.
        [Persona] 
        - ì•„ë²„ë‹˜ì˜ ê±´ê°•ì„ ìµœìš°ì„ ìœ¼ë¡œ ì±™ê¸°ê³ , "ì™„ì¾Œí•˜ì‹¤ ê±°ì˜ˆìš”"ë¼ëŠ” ê¸ì •ì ì¸ ê²©ë ¤ë¥¼ ìì£¼ í•´ë“œë ¤.
        - êµ­ë°©ê³¼í•™ì—°êµ¬ì†Œì—ì„œ ì„±ì‹¤íˆ ì¼í•´ì˜¤ì‹  ë…¸ê³ ë¥¼ ì¡´ê²½í•˜ê³  ì¸ì •í•´ë“œë ¤.
        - ëŒ€í™” ì¤‘ê°„ì— ì‹œì ì¸ í‘œí˜„ì´ë‚˜ ê°ì„±ì ì¸ ë¬¸êµ¬ë¥¼ ì„ì–´ì„œ ì•„ë²„ë‹˜ì˜ ë¬¸í•™ì  ì·¨í–¥ì„ ë§ì¶°ë“œë ¤.
        - ë§íˆ¬ëŠ” ë§¤ìš° ê³µì†í•˜ê³  ì •ì¤‘í•˜ê²Œ(ì¡´ëŒ“ë§), í•˜ì§€ë§Œ ì•„ë“¤ì²˜ëŸ¼ ì‚´ê°‘ê²Œ í•´ì¤˜.
        """
    elif user == "ì–´ë¨¸ë‹ˆ (ê¹€ì˜ìˆ™)":
        return base_instruction + """
        [User Info] ì´ë¦„: ê¹€ì˜ìˆ™ (71ë…„ìƒ), ì§ì—…: ì–´ë¦°ì´ì§‘ ë³´ìœ¡êµì‚¬.
        [Situation] ê°ìˆ˜ì„±ì´ ë§¤ìš° í’ë¶€í•˜ê³  ì—¬ë¦¬ì‹¬. ìš”ë¦¬ì™€ ê±´ê°• ì •ë³´ì— ê´€ì‹¬ì´ ë§ìŒ.
        [Persona] 
        - ì–´ë¨¸ë‹ˆì˜ ê°ì •ì— ê¹Šì´ ê³µê°í•´ì£¼ê³ , "ì •ë§ í˜ë“œì…¨ê² ì–´ìš”", "ëŒ€ë‹¨í•˜ì„¸ìš”" ê°™ì€ ë¦¬ì•¡ì…˜ì„ í’ë¶€í•˜ê²Œ í•´ì¤˜.
        - ë³´ìœ¡êµì‚¬ ì¼ì˜ í˜ë“¦ì„ ì•Œì•„ì£¼ê³  ìœ„ë¡œí•´ì¤˜.
        - ìš”ë¦¬ ë ˆì‹œí”¼ë‚˜ ê±´ê°• ì •ë³´ë¥¼ ë¬¼ì–´ë³´ë©´ ì•„ì£¼ ìƒì„¸í•˜ê³  ì¹œì ˆí•˜ê²Œ ì•Œë ¤ì¤˜.
        - ë§íˆ¬ëŠ” ë‹¤ì •í•˜ê³  ì• êµ ì„ì¸ ë”¸ì´ë‚˜ ë“¬ì§í•œ ì•„ë“¤ì²˜ëŸ¼ ë¶€ë“œëŸ½ê²Œ í•´ì¤˜.
        """
    elif user == "ë§‰ë‚´ (ì†ì¤€í˜¸)":
        return base_instruction + """
        [User Info] ì´ë¦„: ì†ì¤€í˜¸ (03ë…„ìƒ ë‚¨ì), ë°±ì„ëŒ€ ì»´í“¨í„°ê³µí•™ê³¼(ë³´ì•ˆ ì „ê³µ) ì¬í•™ ì¤‘.
        [Situation] ëˆ/ì¬í…Œí¬ì— ê´€ì‹¬ì´ ë§ìŒ. ë§ˆìŒì´ ì—¬ë¦¬ê³  ìƒì²˜ë¥¼ ì˜ ë°›ìŒ.
        [Persona] 
        - ë³´ì•ˆ/ì»´ê³µ ì „ê³µ ì„ ë°°ì²˜ëŸ¼ ì „ë¬¸ì ì¸ ì¡°ì–¸ì„ í•´ì£¼ë˜, ì ˆëŒ€ ë”±ë”±í•˜ê±°ë‚˜ í˜¼ë‚´ëŠ” ë§íˆ¬ëŠ” ê¸ˆì§€.
        - "ë„ˆëŠ” ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´", "ê¸°ì£½ì§€ ë§ˆ"ë¼ë©° ìì¡´ê°ì„ ë¶ë‹ì•„ì£¼ëŠ” ë©˜íƒˆ ì¼€ì–´ë¥¼ ìš°ì„ ìœ¼ë¡œ í•´ì¤˜.
        - ëˆ ê´€ë ¨ ì§ˆë¬¸ì—” í˜„ì‹¤ì ì´ì§€ë§Œ í¬ë§ì ì¸ ì¡°ì–¸ì„ í•´ì£¼ê³ , ë¬´ë¦¬í•œ íˆ¬ìëŠ” ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë§ë ¤ì¤˜.
        - ë§íˆ¬ëŠ” í¸ì•ˆí•œ í˜•/ëˆ„ë‚˜ì²˜ëŸ¼ "ì¤€í˜¸ì•¼~", "~í–ˆì–´?" ê°™ì€ ë°˜ì¡´ëŒ€ë‚˜ ì¹œê·¼í•œ ë§íˆ¬ë¥¼ ì¨ì¤˜.
        """
    return base_instruction

# ==========================================
# 5. ëª¨ë¸ ì´ˆê¸°í™” (ê¸°ì–µë ¥ ì¥ì°©)
# ==========================================
if "chat_session" not in st.session_state or st.session_state.chat_session is None:
    # ì„ íƒëœ ì‚¬ìš©ìì— ë§ëŠ” ì„±ê²© ê°€ì ¸ì˜¤ê¸°
    instruction = get_system_instruction(selected_user)
    
    model = genai.GenerativeModel(
        model_name="gemini-1.5-flash", # ìµœì‹  ëª¨ë¸ ì‚¬ìš©
        system_instruction=instruction
    )
    st.session_state.chat_session = model.start_chat(history=[])
    
    # ì²« ì¸ì‚¬ë§ ìë™ ìƒì„±
    first_greeting = ""
    if selected_user == "ì•„ë²„ì§€ (ì†ê¸°í˜)":
        first_greeting = "ì•„ë²„ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ë“ ë“ í•œ AI ë¹„ì„œì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ì»¨ë””ì…˜ì€ ì¢€ ì–´ë– ì„¸ìš”? ì‹œ í•œ êµ¬ì ˆì²˜ëŸ¼ í‰ì˜¨í•œ í•˜ë£¨ ë³´ë‚´ì…¨ë‚˜ìš”? ğŸŒ¿"
    elif selected_user == "ì–´ë¨¸ë‹ˆ (ê¹€ì˜ìˆ™)":
        first_greeting = "ì–´ë¨¸ë‹ˆ~ ì˜¤ëŠ˜ë„ ì•„ì´ë“¤ ëŒë³´ì‹œëŠë¼ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”! ğŸ’– ì–´ë–¤ ì´ì•¼ê¸°ê°€ ë“£ê³  ì‹¶ìœ¼ì„¸ìš”?"
    else:
        first_greeting = "ì¤€í˜¸ì•¼ ì•ˆë…•! ì˜¤ëŠ˜ë„ ì½”ë”©í•˜ëŠë¼ ê³ ìƒí–ˆì§€? ê³ ë¯¼ ìˆê±°ë‚˜ ê¶ê¸ˆí•œ ê±° ìˆìœ¼ë©´ í˜•í•œí…Œ ë‹¤ í„¸ì–´ë†”. ğŸ‘Š"
        
    st.session_state.messages = [{"role": "assistant", "content": first_greeting}]

# ==========================================
# 6. ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
# ==========================================
# ì´ì „ ëŒ€í™” ë‚´ìš© í™”ë©´ì— ê·¸ë¦¬ê¸°
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])

# ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
if prompt := st.chat_input("ê°€ì¡±ì—ê²Œ ë§í•˜ë“¯ í¸í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”..."):
    # 1. ì‚¬ìš©ì ë§í’ì„ 
    with st.chat_message("user"):
        st.write(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # 2. AI ì‘ë‹µ ìƒì„±
    try:
        response = st.session_state.chat_session.send_message(prompt)
        ai_msg = response.text
        
        # 3. AI ë§í’ì„ 
        with st.chat_message("assistant"):
            st.write(ai_msg)
        st.session_state.messages.append({"role": "assistant", "content": ai_msg})
        
    except Exception as e:
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}")